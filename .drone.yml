build:
  image: ensime/ensime:latest
  pull: true
  environment:
    - SONATYPE_USERNAME=$$SONATYPE_USERNAME
    - SONATYPE_PASSWORD=$$SONATYPE_PASSWORD
    - EMACS=/opt/emacs-24.5/bin/emacs
    - AKKA_TEST_TIMEFACTOR=10
    - SBT_TASK_LIMIT=6
  commands:
    - if $(git grep -qE "TODO|FIXME" -- `git ls-files | grep -v .drone.yml`) ; then
        echo "Please remove TODO or FIXME. Create an issue at GitHub instead." ;
        exit 1 ;
      fi
    - git log | head -n 20
    - host `curl -s http://httpbin.org/ip | jq -r '.origin'` || true ;
    - sbt ++$SCALA_VERSION gen-ensime ;
      sbt ++$SCALA_VERSION clean test:compile it:compile doc ;
      if $(! git diff --exit-code --quiet) ; then
        echo "Code formatting does not meet the project's standards:" ;
        git --no-pager diff ;
        exit 1 ;
      fi
    - sbt ++$SCALA_VERSION test it:test
    - sbt ++$SCALA_VERSION publishLocal ;
      git clone --depth 1 https://github.com/ensime/ensime-emacs.git ensime-emacs ;
      cd ensime-emacs ;
      cask pkg-file ;
      cask install ;
      cask build ;
      test/run_emacs_tests.sh ;

matrix:
  SCALA_VERSION:
    - 2.11.8-tl-201604151108
